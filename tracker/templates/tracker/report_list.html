{% extends 'base.html' %}
{% block title %}Reports Dashboard{% endblock %}

{% block content %}
{{ monthly_graft_data }}

<div class="max-w-7xl mx-auto p-6">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-100">Reports Dashboard</h1>
        <a href="{% url 'tracker:admin_dashboard' %}" class="text-sm text-teal-400 hover:underline">&larr; Back to Admin Dashboard</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-200 text-center">All-Time Packaged Grafts</h2>
            <div class="relative h-80"><canvas id="packagedChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-200 text-center">All-Time Labeled Grafts</h2>
            <div class="relative h-80"><canvas id="labeledChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-200 text-center">All-Time FPP Inspected Grafts</h2>
            <div class="relative h-80"><canvas id="fppChart"></canvas></div>
        </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-200">Monthly Grafts Handled by PROD/QC/QA</h2>
        <canvas id="monthlyGraftsChart" height="150"></canvas>
    </div>

    <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-200">Interactive Packaged Report</h2>
        <div id="interactive-report-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="product_type_filter" class="block text-sm font-medium text-gray-300">Filter by Product Type</label>
                <select id="product_type_filter" name="product_type" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2">
                    <option value="all">All Product Types</option>
                    {% for p_type in all_product_types %}{% if p_type %}<option value="{{ p_type }}">{{ p_type }}</option>{% endif %}{% endfor %}
                </select>
            </div>
            <div>
                <label for="year_filter" class="block text-sm font-medium text-gray-300">Filter by Year</label>
                <select id="year_filter" name="year" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2">
                    <option value="all">All Years</option>
                    {% for year in years %}<option value="{{ year }}">{{ year }}</option>{% endfor %}
                </select>
            </div>
        </div>
        <div class="relative h-80"><canvas id="interactiveChart"></canvas></div>
    </div>

    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
        <h2 class="text-xl font-semibold mb-4">Detailed 12-Month Trend Reports</h2>
        <form method="post" action="{% url 'tracker:report_list' %}" class="mb-6">
            {% csrf_token %}
            <button type="submit" class="bg-purple-600 text-white px-5 py-2 rounded-md hover:bg-purple-700">Generate / Refresh Report</button>
        </form>
        <ul class="divide-y divide-gray-700">
            {% for report in reports %}
                <li class="py-3 flex justify-between items-center">
                    <div>
                        <p class="font-medium text-gray-100">12-Month Trend Report</p>
                        <p class="text-xs text-gray-500">Last Generated: {{ report.generated_at|date:"Y-m-d" }}</p>
                    </div>
                    <div class="flex space-x-4">
                        <a href="{% url 'tracker:report_detail' report.id %}" class="bg-teal-600 text-white px-5 py-2 rounded-md hover:bg-teal-700 text-sm">View Details</a>
                        <form action="{% url 'tracker:delete_report' report.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit"
                                    class="bg-red-700 text-white px-5 py-2 rounded-md hover:bg-red-800 text-sm"
                                    onclick="return confirm('Are you sure you want to permanently delete this report?');">
                                Delete
                            </button>
                        </form>
                    </div>
                </li>
            {% empty %}
                <li class="py-3 text-gray-400">No detailed reports have been generated yet.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Parse chart data from template context ---
    const packagedData = JSON.parse('{{ packaged_chart_data|default:"[]"|safe }}');
    const labeledData = JSON.parse('{{ labeled_chart_data|default:"[]"|safe }}');
    const fppData = JSON.parse('{{ fpp_chart_data|default:"[]"|safe }}');
    const monthlyData = JSON.parse('{{ monthly_graft_data|default:"[]"|safe }}');

    // ðŸ‘€ Debug monthly data
    console.log('Monthly Grafts Chart Data:', monthlyData);

    // --- Chart rendering helper ---
    const createSummaryChart = (canvasId, chartLabel, data, color) => {
        const ctx = document.getElementById(canvasId);
        if (!ctx || !data || data.length === 0 || !data.some(item => item.total > 0)) {
            if (ctx) {
                ctx.parentNode.innerHTML = '<p class="text-center text-gray-500 mt-24">No meaningful data to display.</p>';
            }
            return;
        }

        const labels = data.map(item => item.product_type);
        const values = data.map(item => item.total);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: chartLabel,
                    data: values,
                    backgroundColor: color
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#9ca3af' },
                        grid: { color: '#4b5563' }
                    },
                    x: {
                        ticks: { color: '#9ca3af' },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    };

    // --- Render charts ---
    createSummaryChart('packagedChart', 'Total Packaged', packagedData, 'rgba(20, 184, 166, 0.6)');
    createSummaryChart('labeledChart', 'Total Labeled', labeledData, 'rgba(59, 130, 246, 0.6)');
    createSummaryChart('fppChart', 'Total FPP Inspected', fppData, 'rgba(139, 92, 246, 0.6)');
    createSummaryChart('monthlyGraftsChart', 'Monthly Grafts', monthlyData, 'rgba(234, 88, 12, 0.6)');

    // --- Interactive Filtered Report Chart ---
    const interactiveCtx = document.getElementById('interactiveChart').getContext('2d');
    let interactiveChart;

    const updateInteractiveChart = (graftData, lotData) => {
        if (interactiveChart) interactiveChart.destroy();

        interactiveChart = new Chart(interactiveCtx, {
            type: 'bar',
            data: {
                labels: ['Filtered Result'],
                datasets: [
                    {
                        label: 'Total Grafts',
                        data: [graftData],
                        backgroundColor: 'rgba(234, 179, 8, 0.6)',
                        yAxisID: 'yGrafts'
                    },
                    {
                        label: 'Total Lots',
                        data: [lotData],
                        backgroundColor: 'rgba(168, 85, 247, 0.6)',
                        yAxisID: 'yLots'
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    yGrafts: {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        ticks: { color: '#9ca3af' },
                        grid: { color: '#4b5563' }
                    },
                    yLots: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        ticks: { color: '#9ca3af' },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#d1d5db' } }
                }
            }
        });
    };

    const fetchInteractiveData = () => {
        const productType = document.getElementById('product_type_filter').value;
        const year = document.getElementById('year_filter').value;
        const url = `{% url 'tracker:interactive_report_data' %}?product_type=${productType}&year=${year}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateInteractiveChart(data.total_grafts, data.total_lots);
            })
            .catch(error => {
                console.error('Failed to fetch interactive data:', error);
            });
    };

    document.getElementById('product_type_filter').addEventListener('change', fetchInteractiveData);
    document.getElementById('year_filter').addEventListener('change', fetchInteractiveData);

    fetchInteractiveData(); // Initial load
});
</script>

{% endblock %}