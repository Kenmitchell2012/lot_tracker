{% extends 'base.html' %}
{% load static %}
{% block title %}Report: 12-Month Trends{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="flex justify-between items-start mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-100">12-Month Trend Report</h1>
            <p class="text-gray-400">Generated on: {{ report.generated_at|date:"F j, Y" }}</p>
            <a href="{% url 'tracker:report_list' %}" class="inline-flex items-center text-sm text-teal-400 hover:text-teal-300 mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                Back to Reports Dashboard
            </a>
        </div>
        <div>
            <form action="{% url 'tracker:delete_report' report.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="bg-red-700 text-white font-semibold px-4 py-2 rounded-md hover:bg-red-800" onclick="return confirm('Are you sure you want to permanently delete this report?');">
                    Delete Report
                </button>
            </form>
        </div>
    </div>

    <div class="space-y-8">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-200 text-center">Packaged Grafts Trend</h2>
            <div class="relative h-96"><canvas id="packagedTrendChart"></canvas></div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-200 text-center">Labeled Grafts Trend</h2>
            <div class="relative h-96"><canvas id="labeledTrendChart"></canvas></div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-200 text-center">FPP Inspected Trend</h2>
            <div class="relative h-96"><canvas id="fppTrendChart"></canvas></div>
        </div>
    </div>
</div>

{{ report.report_data|json_script:"report-data-json" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportDataElement = document.getElementById('report-data-json');
    const reportData = JSON.parse(reportDataElement.textContent);

    const packagedTrend = reportData.packaged_trend || [];
    const labeledTrend = reportData.labeled_trend || [];
    const fppTrend = reportData.fpp_trend || [];

    // The createTrendChart function has been updated
    const createTrendChart = (canvasId, chartLabel, data, color, borderColor) => {
        const ctx = document.getElementById(canvasId);
        if (!ctx || !data || data.length === 0) {
            ctx.parentNode.innerHTML = '<p class="text-center text-gray-500 mt-24">No data available.</p>';
            return;
        }

        const labels = data.map(item => {
            const date = new Date(item.month + 'T00:00:00');
            return date.toLocaleString('default', { month: 'short', year: '2-digit' });
        });
        const values = data.map(item => item.total);

        new Chart(ctx, {
            // 1. Changed chart type to 'line' for better trend visualization
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: chartLabel,
                    data: values,
                    backgroundColor: color,       // Fill color under the line
                    borderColor: borderColor,   // Line color
                    borderWidth: 3,
                    pointBackgroundColor: borderColor,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.3,               // Makes the line smooth
                    fill: true,
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { color: '#9ca3af' }, 
                        grid: { color: '#4b5563' } 
                    },
                    x: { 
                        ticks: { color: '#9ca3af' }, 
                        grid: { display: false } 
                    }
                },
                plugins: { 
                    legend: { display: false },
                    // 2. Added configuration for the datalabels plugin
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#e5e7eb', // Light text color for labels
                        font: {
                            weight: 'bold',
                            size: 12,
                        },
                        // Format the number with commas (e.g., 10000 -> 10,000)
                        formatter: (value) => value.toLocaleString(),
                        // Add a subtle shadow for readability
                        textStrokeColor: 'black',
                        textStrokeWidth: 2,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString();
                                }
                                return label;
                            }
                        }
                    }
                }
            },
            // 3. Registered the datalabels plugin for this chart instance
            plugins: [ChartDataLabels],
        });
    };

    // Call the function with updated colors for line charts
    createTrendChart('packagedTrendChart', 'Total Packaged', packagedTrend, 'rgba(20, 184, 166, 0.2)', 'rgba(20, 184, 166, 1)');
    createTrendChart('labeledTrendChart', 'Total Labeled', labeledTrend, 'rgba(59, 130, 246, 0.2)', 'rgba(59, 130, 246, 1)');
    createTrendChart('fppTrendChart', 'Total FPP Inspected', fppTrend, 'rgba(139, 92, 246, 0.2)', 'rgba(139, 92, 246, 1)');
});
</script>
{% endblock %}